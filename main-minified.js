javascript:(async function(){function e(e){return new Promise(t=>{setTimeout(()=>t(),e)})}async function t(e,{filename:t="chatgpt.json"}={}){let n=JSON.stringify(e,null,4),o=new Blob([n],{type:"application/json"}),a=document.createElement("a");a.href=URL.createObjectURL(o),a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(a.href)}function n(e,t={}){return new Promise(n=>{e.scrollIntoView(t);let o=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(n(),o.disconnect())})});o.observe(e)})}async function o(t,n,{timeout:o=1e3}={}){console.log(`waiting for "${n}" from"`,t);let a;if((a=t.querySelector(n))||(await e(o),a=t.querySelector(n)))return a;throw{timeout:!0,query_from:t,selector:n}}async function a(e){let t=await fetch(e);if(!t.ok)throw Error("Failed to fetch image");let n=await t.blob(),o=n.type,a=new FileReader;return new Promise((e,t)=>{a.onloadend=()=>e({mimeType:o,data:a.result}),a.onerror=()=>t(Error("Failed to read blob")),a.readAsDataURL(n)})}async function r(e){return new Promise((t,n)=>{if(!(e instanceof HTMLImageElement))return n(Error("Invalid image tag"));let o=document.createElement("canvas"),a=o.getContext("2d");o.width=e.width,o.height=e.height,a.drawImage(e,0,0);let r=o.toDataURL(),l=r.split(";")[0].split(":")[1];t({data:r.split(",")[1],mimeType:l})})}async function l(){let t=function e(){let t=window.location.href.match(/(\/c\/.*)$/),n=t?t[0]:null;if(n)return document.querySelector(`a[href="${n}"]`)}();if(!t){console.warn("cannot reload because return-button not found");return}console.log("going to main");let n=document.querySelector('a[href="/"]');if(!n){console.warn("cannot reload because main-button not found");return}n.click(),await e(500),await o(document.body,".composer-parent #prompt-textarea"),console.log("going back by clicking",t),t.click(),await e(500),await o(document.body,"main .h-full article",{timeout:5e3})}document.querySelector(".group\\/dalle-image")&&window.confirm("Reload chat?\n\nFound some DALL-E images in your chat. DALL-E images are protected and might not download well without reloading.\n\nOK to reload now?")&&await l();let i=document.querySelectorAll("main .h-full article");if(!i)return alert("no chat history found"),!1;i[0].parentElement.parentElement.scrollTo(0,0);let c=[],u=Array.from(i),s=u.length-1,d=0;for(let[f,h]of Object.entries(u)){console.log(`message : ${f}/${s}`,h),await n(h);try{let y={from:"",body:[]},m=await o(h,".text-base"),w=h.querySelector("h5.sr-only"),g=h.querySelector("h6.sr-only");w?(y.user,y.from=w.textContent?.match(/^(.*?):$/)?.[1]??w.textContent??"(unknown)"):g&&(y.chatgpt,y.from=g.textContent?.match(/^(.*?):$/)?.[1]??g.textContent??"(unknown)");let p=m.querySelectorAll(".group\\/dalle-image");for(let b of p){let $=b.querySelector("img");if($){let q;try{q=await a($.src)}catch(S){d++}finally{y.body.push(q)}}}let L=m.querySelector("[data-message-id] .w-full").children;for(let k of L){Array.from(k.classList).includes("markdown")&&y.body.push(k.innerHTML);let j=k.querySelector(".whitespace-pre-wrap");j&&y.body.push(j.innerHTML);let x=k.querySelector("img");x&&y.body.push(await a(x.src))}c.push(y)}catch(C){console.error(`message ${f} failed because :`,C)}}c.length?(console.log("json object is ready"),await t(c,{filename:`${document.title}.json`})):window.alert("no chat history found")})();

javascript:
(()=>{(async function(){if(typeof document>"u"||typeof window>"u")throw new Error("<<< this is a bookmarklet; please run it in a browser >>>");function y(e){return new Promise(t=>{setTimeout(()=>t(),e)})}function $(e,{actions:t=[],done_caption:s="Done"}={}){return new Promise(a=>{let n=document.getElementById("custom_modal");n&&n.querySelector("button.done").click();let l=document.createElement("div");l.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 9999; ",document.body.appendChild(l);let o=document.createElement("div");o.id="custom_modal",o.style.cssText="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; background-color: white; border-radius: 1em; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); z-index: 10000; width: 300px; text-align: center;  box-shadow: 0 22px 70px 4px rgba(0, 0, 0, 0.56); ";let i=document.createElement("div");i.style.cssText=" margin-bottom: 20px; font-size: 16px; color: #333; ",i.innerText=e;let c=document.createElement("ul");c.style.cssText=" list-style: none; padding: 0; margin: 0; ";let r=!1;function f(){r||(o.remove(),l.remove(),a(),r=!0)}let d="padding: 10px 20px; border: none; border-radius: 2em; color: white; cursor: pointer; font-size: 16px; margin: 10px 0;";for(let w of t){let u=document.createElement("button");u.innerText=w.caption,u.style.cssText=`${d}; background-color: #007BFF;`,u.onclick=()=>{w.callback({dismiss:f}),w.dismiss&&f()};let g=document.createElement("li");g.appendChild(u),c.appendChild(g)}let m=document.createElement("button");m.className="done",m.innerText=s??"Done",m.style.cssText=`${d}; background-color: #4CAF50;`,m.onclick=()=>{f()};let b=document.createElement("li");return b.appendChild(m),c.appendChild(b),o.appendChild(i),o.appendChild(c),document.body.appendChild(o),new Promise(w=>{o.resolve=w})})}function S(e,t){return`<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="initial-scale = 1.0,maximum-scale = 1.0" /><style type="text/css">body,pre{font-family:helvetica,arial,san-serif}body{padding:1em;background:#303030;color:#fff;font-size:14pt;line-height:1.8em}dt{color:rgba(255,255,255,.5);font-weight:700}img{ max-width: 100%; height: auto; display: block;}pre.user{white-space:pre-wrap;}dd>ul{list-style: none; margin: 0; padding :0;}dd>ul>li{ margin: 0; padding :0; }</style><title>${t}</title></head><body><dl>`+e.map(({from:n,from_user:l,from_bot:o,body:i})=>{let c="",r="";if(l)if(c=n,i.length===1){let f="pre";typeof i[0]=="string"?r=`<${f} class="user">${i[0]}</${f}>`:i[0]?.mimeType?.startsWith("image/")?r=`<img src="${i[0].data}" />`:r="unknown"}else i.length>1&&(r="<ul>"+i.map(d=>{let m="pre";return typeof d=="string"?`<li><${m} class="user">${d}</${m}></li>`:d?.mimeType.startsWith("image/")?`<li><img src="${d.data}" /></li>`:"<li>unknown</li>"}).join("")+"</ul>");else o&&(c=n,i.length===1?typeof i[0]=="string"?r=i[0]:i[0]?.mimeType?.startsWith("image/")?r=`<img src="${i[0].data}" />`:r="unknown":i.length>1&&(r="<ul>"+i.map(d=>typeof d=="string"?`<li>${d}></li>`:d?.mimeType.startsWith("image/")?`<li><img src="${d.data}" /></li>`:"<li>unknown</li>").join(`
`)+"</ul>"));return`<dt>${c}</dt><dd>${r}</dd>`}).join(`
`)+"</dl></body></html>"}async function k(e,{type:t="application/json",filename:s="chat.json"}={}){let a=new Blob([e],{type:t}),n=document.createElement("a");n.href=URL.createObjectURL(a),n.download=s,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(n.href)}function A(e,t={}){return new Promise(s=>{e.scrollIntoView(t);let a=new IntersectionObserver(n=>{n.forEach(l=>{l.isIntersecting&&(s(),a.disconnect())})});a.observe(e)})}async function _(e,t,{timeout:s=1e3,interval:a=500}={}){console.log(`waiting for "${t}" from"`,e);let n=!1,l=setTimeout(()=>{console.warn("timed out"),n=!0},s);for(;;){let o;if(o=e.querySelector(t),o)return clearTimeout(l),console.log(`got "${t}" from`,e,"-->",o),o;if(await y(a),n)throw new Error("timed out")}}async function E(e){let t=await fetch(e);if(!t.ok)throw new Error("Failed to fetch image");let s=await t.blob(),a=s.type,n=new FileReader;return new Promise((l,o)=>{n.onloadend=()=>l({mimeType:a,data:n.result}),n.onerror=()=>o(new Error("Failed to read blob")),n.readAsDataURL(s)})}async function D(e){return new Promise((t,s)=>{try{if(!(e instanceof HTMLImageElement))return s(new Error("Invalid image tag"));let a=document.createElement("canvas"),n=a.getContext("2d");a.width=e.width,a.height=e.height,n.drawImage(e,0,0);let l=a.toDataURL(),o=l.split(";")[0].split(":")[1];return t({data:l.split(",")[1],mimeType:o})}catch(a){return console.warn("get_image_data failed",{img_tag:e,error:a}),s({error:a})}})}function C(){let e=window.location.href.match(/(\/c\/.*)$/),t=e?e[0]:null;if(t)return document.querySelector(`a[href="${t}"]`)}async function L(){let e=C();if(!e){console.warn("cannot reload because return-button not found");return}let t=document.querySelector('a[href="/"]');if(!t){console.warn("cannot reload because main-button not found");return}console.log("main",t),t.click(),await y(1e3),await _(document.body,".composer-parent #prompt-textarea",{timeout:30*1e3}),console.log("return",e),e.click(),await y(1e3),await _(document.body,'main .h-full svg[role="img"]',{timeout:30*1e3})}async function q(){let e=document.querySelectorAll("main .h-full article");if(!e){console.warn("no chat history found");return}e[0].parentElement.parentElement.scrollTo(0,0);let t=[],s=Array.from(e),a=s.length-1,n=[],l=0;for(let[i,c]of Object.entries(s)){console.log(`** message : ${i}/${a}`,c),await A(c);try{let r={from:"",from_user:!1,from_bot:!1,body:[]},f=await _(c,".text-base"),d=c.querySelector("h5.sr-only"),m=c.querySelector("h6.sr-only");d?(r.from_user=!0,r.from=d.textContent?.match(/^(.*?):$/)?.[1]??d.textContent??"(unknown)"):m&&(r.from_bot=!0,r.from=m.textContent?.match(/^(.*?):$/)?.[1]??m.textContent??"(unknown)");let b=f.querySelectorAll(".group\\/dalle-image");for(let u of b){let g=u.querySelector("img");if(g){let h;try{h=await E(g.src)}catch{n.push("dall-e")}finally{r.body.push(h)}}}let w=f.querySelector("[data-message-id] .w-full").children;for(let u of w){if(Array.from(u.classList).includes("markdown")){let h=u.cloneNode(!0),x=h.getElementsByTagName("button");for(;x.length>0;)x[0].parentNode.removeChild(x[0]);for(let p of Array.from(h.getElementsByTagName("*")))p.classList.contains("text-token-text-secondary")&&p.textContent?.trim()&&(p.textContent=`// ${p.textContent}`),p.removeAttribute("class");let v=h.getElementsByTagName("code");for(let p=v.length-1;p>=0;p--){let T=v[p];if(T.children.length===0)continue;let{textContent:I}=T;T.textContent=I}r.body.push(h.innerHTML.replaceAll(/<\/?div>/g,""))}let g=u.querySelector(".whitespace-pre-wrap");g&&r.body.push(g.innerHTML);try{let h=u.querySelector("img");h&&r.body.push(await E(h.src))}catch{console.warn("failed to download img from",u),n.push("general-img")}}t.push(r)}catch(r){console.error(`message ${i} failed because :`,r),l++}}let o={chat:t,img_errs:n,uncaught_errs:l};return console.log("Done!",o),o}function R(){return new Promise(async e=>{let{chat:t,img_errs:s,uncaught_errs:a}=await q()??{};if(console.log("result:",{chat:t,img_errs:s,uncaught_errs:a}),t?.length){let n=s?.length>0,l=C()?.textContent??`${document.title} (untitled)`,o=S(t,l),i=n?`Some images could not be downloaded from "${l}". They are protected, and usually have to be downloaded quickly after page load.`:`"${l}" is ready for download`;await $(i,{actions:[n?{caption:"Reload and Try Again",callback:({dismiss:c})=>{e("retry"),c()}}:null,{caption:"Save as HTML",callback:async()=>{console.log(o),await k(o,{type:"text/html",filename:`${document.title}.html`}),e(!0)}},{caption:"Save as JSON",callback:async()=>{console.log(t),await k(JSON.stringify(t,"",4),{filename:`${document.title}.json`}),e(!0)}}].filter(c=>!!c)})}else return await $("No chat message captured.",{done_caption:"Sorry"}),!1})}for(;;){if(await R()==="retry"){console.log("will retry"),await y(500),await L();continue}break}})();})();

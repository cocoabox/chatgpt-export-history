javascript:
(()=>{(async function(){if(typeof document>"u"||typeof window>"u")throw new Error("<<< this is a bookmarklet; please run it in a browser >>>");function y(e){return new Promise(t=>{setTimeout(()=>t(),e)})}function $(e,{actions:t=[],done_caption:c="Done"}={}){return new Promise(l=>{let n=document.getElementById("custom_modal");n&&n.querySelector("button.done").click();let a=document.createElement("div");a.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 9999; ",document.body.appendChild(a);let o=document.createElement("div");o.id="custom_modal",o.style.cssText="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; background-color: white; border-radius: 1em; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); z-index: 10000; width: 300px; text-align: center;  box-shadow: 0 22px 70px 4px rgba(0, 0, 0, 0.56); ";let i=document.createElement("div");i.style.cssText=" margin-bottom: 20px; font-size: 16px; color: #333; ",i.innerText=e;let s=document.createElement("ul");s.style.cssText=" list-style: none; padding: 0; margin: 0; ";let r=!1;function f(){r||(o.remove(),a.remove(),l(),r=!0)}let d="padding: 10px 20px; border: none; border-radius: 2em; color: white; cursor: pointer; font-size: 16px; margin: 10px 0;";for(let w of t){let u=document.createElement("button");u.innerText=w.caption,u.style.cssText=`${d}; background-color: #007BFF;`,u.onclick=()=>{w.callback({dismiss:f}),w.dismiss&&f()};let p=document.createElement("li");p.appendChild(u),s.appendChild(p)}let m=document.createElement("button");m.className="done",m.innerText=c??"Done",m.style.cssText=`${d}; background-color: #4CAF50;`,m.onclick=()=>{f()};let b=document.createElement("li");return b.appendChild(m),s.appendChild(b),o.appendChild(i),o.appendChild(s),document.body.appendChild(o),new Promise(w=>{o.resolve=w})})}function A(e,t){return`<!DOCTYPE html><html><head><style type="text/css">body,pre{font-family:helvetica,arial,san-serif}body{padding:1em;background:#303030;color:#fff;font-size:14pt;line-height:1.8em}dt{color:rgba(255,255,255,.5);font-weight:700}</style><title>${t}</title></head><body><dl>`+e.map(({from:n,from_user:a,from_bot:o,body:i})=>{let s="",r="";if(a)if(s=n,i.length===1){let f="p";typeof i[0]=="string"?r=`<${f}>${i[0]}</${f}>`:i[0]?.mimeType?.startsWith("image/")?r=`<img src="${i[0].data}" />`:r="unknown"}else i.length>1&&(r="<ul>"+i.map(d=>{let m="p";return typeof d=="string"?`<li><${m}>${d}</${m}></li>`:d?.mimeType.startsWith("image/")?`<li><img src="${d.data}" /></li>`:"<li>unknown</li>"}).join("")+"</ul>");else o&&(s=n,i.length===1?typeof i[0]=="string"?r=i[0]:i[0]?.mimeType?.startsWith("image/")?r=`<img src="${i[0].data}" />`:r="unknown":i.length>1&&(r="<ul>"+i.map(d=>typeof d=="string"?`<li>${d}></li>`:d?.mimeType.startsWith("image/")?`<li><img src="${d.data}" /></li>`:"<li>unknown</li>").join(`
`)+"</ul>"));return`<dt>${s}</dt><dd>${r}</dd>`}).join(`
`)+"</dl></body></html>"}async function k(e,{type:t="application/json",filename:c="chat.json"}={}){let l=new Blob([e],{type:t}),n=document.createElement("a");n.href=URL.createObjectURL(l),n.download=c,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(n.href)}function L(e,t={}){return new Promise(c=>{e.scrollIntoView(t);let l=new IntersectionObserver(n=>{n.forEach(a=>{a.isIntersecting&&(c(),l.disconnect())})});l.observe(e)})}async function _(e,t,{timeout:c=1e3,interval:l=500}={}){console.log(`waiting for "${t}" from"`,e);let n=!1,a=setTimeout(()=>{console.warn("timed out"),n=!0},c);for(;;){let o;if(o=e.querySelector(t),o)return clearTimeout(a),console.log(`got "${t}" from`,e,"-->",o),o;if(await y(l),n)throw new Error("timed out")}}async function E(e){let t=await fetch(e);if(!t.ok)throw new Error("Failed to fetch image");let c=await t.blob(),l=c.type,n=new FileReader;return new Promise((a,o)=>{n.onloadend=()=>a({mimeType:l,data:n.result}),n.onerror=()=>o(new Error("Failed to read blob")),n.readAsDataURL(c)})}async function j(e){return new Promise((t,c)=>{if(!(e instanceof HTMLImageElement))return c(new Error("Invalid image tag"));let l=document.createElement("canvas"),n=l.getContext("2d");l.width=e.width,l.height=e.height,n.drawImage(e,0,0);let a=l.toDataURL(),o=a.split(";")[0].split(":")[1];t({data:a.split(",")[1],mimeType:o})})}function C(){let e=window.location.href.match(/(\/c\/.*)$/),t=e?e[0]:null;if(t)return document.querySelector(`a[href="${t}"]`)}async function v(){let e=C();if(!e){console.warn("cannot reload because return-button not found");return}let t=document.querySelector('a[href="/"]');if(!t){console.warn("cannot reload because main-button not found");return}console.log("main",t),t.click(),await y(1e3),await _(document.body,".composer-parent #prompt-textarea",{timeout:30*1e3}),console.log("return",e),e.click(),await y(1e3),await _(document.body,'main .h-full svg[role="img"]',{timeout:30*1e3})}async function q(){let e=document.querySelectorAll("main .h-full article");if(!e){console.warn("no chat history found");return}e[0].parentElement.parentElement.scrollTo(0,0);let t=[],c=Array.from(e),l=c.length-1,n=[],a=0;for(let[i,s]of Object.entries(c)){console.log(`message : ${i}/${l}`,s),await L(s);try{let r={from:"",from_user:!1,from_bot:!1,body:[]},f=await _(s,".text-base"),d=s.querySelector("h5.sr-only"),m=s.querySelector("h6.sr-only");d?(r.from_user=!0,r.from=d.textContent?.match(/^(.*?):$/)?.[1]??d.textContent??"(unknown)"):m&&(r.from_bot=!0,r.from=m.textContent?.match(/^(.*?):$/)?.[1]??m.textContent??"(unknown)");let b=f.querySelectorAll(".group\\/dalle-image");for(let u of b){let p=u.querySelector("img");if(p){let h;try{h=await E(p.src)}catch{n.push("dall-e")}finally{r.body.push(h)}}}let w=f.querySelector("[data-message-id] .w-full").children;for(let u of w){if(Array.from(u.classList).includes("markdown")){let h=u.cloneNode(!0),x=h.getElementsByTagName("button");for(;x.length>0;)x[0].parentNode.removeChild(x[0]);for(let g of Array.from(h.getElementsByTagName("*")))g.classList.contains("text-token-text-secondary")&&g.textContent?.trim()&&(g.textContent=`// ${g.textContent}`),g.removeAttribute("class");let S=h.getElementsByTagName("code");for(let g=S.length-1;g>=0;g--){let T=S[g];if(T.children.length===0)continue;let{textContent:I}=T;T.textContent=I}r.body.push(h.innerHTML.replaceAll(/<\/?div>/g,""))}let p=u.querySelector(".whitespace-pre-wrap");p&&r.body.push(p.innerHTML);try{let h=u.querySelector("img");h&&r.body.push(await E(h.src))}catch{console.warn("failed to download img from",u),n.push("general-img")}}t.push(r)}catch(r){console.error(`message ${i} failed because :`,r),a++}}let o={chat:t,img_errs:n,uncaught_errs:a};return console.log("Done!",o),o}function R(){return new Promise(async e=>{let{chat:t,img_errs:c,uncaught_errs:l}=await q()??{};if(console.log("result:",{chat:t,img_errs:c,uncaught_errs:l}),t?.length){let n=c?.length>0,a=C()?.textContent??`${document.title} (untitled)`,o=A(t,a),i=n?`Some images could not be downloaded from "${a}". They are protected, and usually have to be downloaded quickly after page load.`:`"${a}" is ready for download`;await $(i,{actions:[n?{caption:"Reload and Try Again",callback:({dismiss:s})=>{e("retry"),s()}}:null,{caption:"Save as HTML",callback:async()=>{console.log(o),await k(o,{type:"text/html",filename:`${document.title}.html`}),e(!0)}},{caption:"Save as JSON",callback:async()=>{console.log(t),await k(JSON.stringify(t,"",4),{filename:`${document.title}.json`}),e(!0)}}].filter(s=>!!s)})}else return await $("No chat message captured.",{done_caption:"Sorry"}),!1})}for(;;){if(await v(),await R()==="retry"){console.log("will retry"),await y(500),await v();continue}break}})();})();
